apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: lgtm
  annotations:
    # Use Network Load Balancer for better performance
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    # Enable connection draining
    service.beta.kubernetes.io/aws-load-balancer-connection-draining-enabled: "true"
    service.beta.kubernetes.io/aws-load-balancer-connection-draining-timeout: "60"
    # Cross-zone load balancing
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    # Health check configuration
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol: "http"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: "3000"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-path: "/api/health"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval: "10"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-timeout: "5"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-healthy-threshold: "2"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-unhealthy-threshold: "2"
spec:
  type: LoadBalancer
  selector:
    app: lgtm
  ports:
    - name: grafana
      port: 3000
      targetPort: 3000
      protocol: TCP
  # Optional: Restrict source IPs (configured via Terraform variable)
  # Uncomment and set via kustomize if needed:
  # loadBalancerSourceRanges:
  #   - 1.2.3.4/32
