# Quick Start Guide for k3d

## 1. Create k3d cluster
```bash
k3d cluster create thyme-test --agents 2
```

## 2. Build and load image
```bash
# From repository root
make k3d-load K3D_CLUSTER=thyme-test
```

## 3. Deploy
```bash
# Deploy everything (thyme-benchmark + LGTM stack)
kubectl apply -k deployment/kubernetes/
```

## 4. Wait for everything to be ready
```bash
kubectl wait --for=condition=ready pod -l app=lgtm -n lgtm --timeout=120s
kubectl wait --for=condition=ready pod -l app=nop-collector -n thyme-benchmark --timeout=120s
kubectl get pods -n thyme-benchmark
kubectl get pods -n lgtm
```

## 5. Access Grafana

```bash
kubectl port-forward -n lgtm service/grafana 3000:3000
open http://localhost:3000
# Credentials: admin/admin
```

## 6. Run 10-Minute Test

### Start Test
Log generation starts automatically. Monitor with:
```bash
# Watch pod status
kubectl get pods -n thyme-benchmark -w

# Check log file sizes
kubectl exec -n thyme-benchmark daemonset/thyme -- sh -c 'ls -lh /var/log/pods/thyme-benchmark_log-generator*/app/0.log | head -5'

# Count total log lines
kubectl exec -n thyme-benchmark daemonset/thyme -- sh -c 'wc -l /var/log/pods/thyme-benchmark_log-generator*/app/0.log 2>/dev/null | tail -1'
```

### Monitor in Grafana

1. Open Grafana at http://localhost:30000
2. Navigate to **Explore** → Select **Prometheus** datasource
3. Run these queries:

**Log throughput (logs/sec received by nop-collector):**
```promql
rate(otelcol_receiver_accepted_log_records_total{service_name="nop-collector"}[1m])
```

**Log throughput (logs/sec sent by thyme):**
```promql
rate(otelcol_exporter_sent_log_records_total{service_name="thyme"}[1m])
```

**Thyme CPU usage (cores):**
```promql
rate(otelcol_process_cpu_seconds_total{service_name="thyme"}[1m])
```

**Thyme memory usage (MB):**
```promql
otelcol_process_runtime_heap_alloc_bytes{service_name="thyme"} / 1024 / 1024
```

**Expected Results:**
- **Throughput**: ~50,000 logs/sec (20 pods × 2,500 lines/sec)
- **CPU**: ~1.5 cores for thyme DaemonSet
- **Memory**: < 1 GB for thyme DaemonSet

### Collect Test Results

After 10 minutes, capture final metrics:

```bash
# Total logs generated
TOTAL_LOGS=$(kubectl exec -n thyme-benchmark daemonset/thyme -- sh -c 'wc -l /var/log/pods/thyme-benchmark_log-generator*/app/0.log 2>/dev/null | tail -1 | awk "{print \$1}"')
echo "Total logs generated: $TOTAL_LOGS"

# Expected: ~600,000 (10 min × 60 sec × 10,000 logs/sec)
```

In Grafana, create a dashboard or export metrics:
1. Go to **Explore**
2. Run the queries above with time range: "Last 10 minutes"
3. Click **Inspector** → **Data** → **Download CSV**

### View Collector Debug Info
```bash
# Thyme zpages
kubectl port-forward -n thyme-benchmark daemonset/thyme 55679:55679
open http://localhost:55679/debug/servicez

# nop-collector zpages
kubectl port-forward -n thyme-benchmark deployment/nop-collector 55680:55679
open http://localhost:55680/debug/servicez
```

## Cleanup

### Remove Resources (Keep Cluster)
```bash
# Remove all deployed resources
kubectl delete -k deployment/kubernetes/
```

### Remove Cluster (k3d)
```bash
# Delete the entire k3d cluster
k3d cluster delete thyme-test
```
